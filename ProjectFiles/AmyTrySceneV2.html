OCTYPE html>

<html>
<head>
    <title>Our 3D creation</title>

    <!-- This is the CSS style of this page. -->
    <link rel="stylesheet" href="stylesheet.css" type="text/css">

    <meta http-equiv="Content-type" content="text/html; charset=UTF-8" />

    <!--include the three.js library-->
    <script src="js/three.js"></script>
    <!--and the trackball code-->
    <script src="js/OrbitControls.js"></script>
    <!--include the dat.gui.min.js library to edit the scene in real time-->
    <script src="js/dat.gui.min.js"></script>
    <!--include the stats.js library-->
    <script src="js/stats.js"></script>

    <script src="js/PLYLoader.js"></script>

    <script src="js/MTLLoader.js" ></script>
    <script src="js/OBJLoader.js" ></script>

    <script src="js/jquery.min.js"></script>

</head>


<body>

    <!-- This div element is the top text space on the page. -->
    <div id="info">
        <p>
            Click your mouse to start moving the box!
            <br />
            left   click to rotate, middle click to zoom,  right  click to pan

        </p>

    </div>

    
        <!-- Control panel to interact with the scene -->
    <div id="controls">
        Control Panel
        <br />
        - Move the box
        <hr />

        <div id="camera-position">
            <button id="up">up (W)</button>
            <br />
            <button id="forward">forward (R)</button>
            <br />
            <button id="left">left (A)</button> MOVE <button id="right">right (D)</button>
            <br />
            <button id="backward">backward (F)</button>
            <br />
            <button id="down">down (S)</button>
            <br />
            <br />

        </div>
        <button id="set-box">Set block here!<br />(Enter)</button>
        <br />
        Control Virtual Block: <br /><button id="move">by Click</button>
        <button id="hide">Hide Control Block</button>
        <br />
        Selected Block:
        <button id="color">Pick Color</button>
        <button id="remove">Remove Block</button>
        <button id="remove-all">Remove All Blocks</button>

        <br />
        <button id="save">Save Your Work!</button>

        <button id="load">Load Previous Work!</button>
		
		<br/>
		
		<button id="adventure">Start Adventure!</button>
		<p>Move Car: <br />Forward(i),Backward(k),<br />Left(j),Right(l)</p>
		<button id="screenshot">Screen Shot</button>
        <br />


    </div>
    <!-- This script section is where we add THREE.JS code. -->
    <script>
        //create the scene and camera
        var scene = new THREE.Scene();

        // Monitor the performance.
        var stats = new Stats();
        document.body.appendChild(stats.dom);

        // Create interaction control panel.
        var gui = new dat.GUI();

        var ratio = window.innerWidth / window.innerHeight;
        var camera = new THREE.PerspectiveCamera(45, ratio, 1, 1000);
        // Place the camera (at the coordinate of its neareast parent.)
        camera.position.set(12, 18, 28);
        // Determine which point the camera is looking at.
        camera.lookAt(0, 0, 0);

        scene.add(camera);
		
		////////////////////////add an additional camera for adventure/////////////////////////
		var camera2 = new THREE.PerspectiveCamera(45,ratio,1,1000);
			camera2.position.set(0,8,5);
			camera2.lookAt(scene.position);	
		///////////////////////////////////////////////////////////////////////////////////////
        


    </script>

    <!-- This script section is the function to create and to update the renderer. -->
    <script src="scripts/UpdateRenderer.js"></script>

    <!-- This script section stores the functions about creating objects. -->
    <script src="scripts/CreateObjectsNew.js"></script>
    <script src="scripts/Collections.js"></script>
    <script src="scripts/ObjectsCreation.js"></script>
    <script src="scripts/ForestControl_v2.js"></script>

    <!-- This script section stores the functions about controlling the box with your keyboard. -->
    <script src="scripts/KeyboardOperation.js"></script>
	<script src="js/dat.gui.min.js"></script>


    <!-- This script section is where we add THREE.JS code. -->
    <script>

        // Use the clock to calculate time elapse.
        var clock = new THREE.Clock();
        const clock2 = new THREE.Clock();

        // Change the color of the background to grey.
        renderer.setClearColor(0x555555);


        // Make texture for objects.
        var loader = new THREE.TextureLoader();

        var ground = getPlane(301);

        // Create a plane to see the grid. Always use odd number, ohterwise the position is not accurate.

        ground.position.y = -0.50;
        ground.material.color.setHex(0x88aa88);
        ground.name = 'ground';
        scene.add(ground);

        // var fogColor = new THREE.Color(0xffffff);
        // scene.fog = new THREE.FogExp2(fogColor, 0.01);

        // Used to update block color
        var Color = function (object) {
            this.color = 0xee6666; // RGB with alpha

            // Define render logic ...
            object.material.color.setHex(this.color);

            this.SetColor = function () {
                object.material.color.setHex(this.color);
            }
        };

        var box = getBox(0x000000);
        box.material = new THREE.MeshLambertMaterial();
        box.material.map = loader.load('img/text1.png');
        box.name = 'control';

        scene.add(box);


        colorChanger = new Color(box);

        gui.addColor(colorChanger, 'color');



        var bone = getBoxBone();
        bone.visible = false;
        scene.add(bone);


        // Environment light
        var ambientLight = getAmbientLight(3);
        scene.add(ambientLight);

        var pointLight = getPointLight(1);
        scene.add(pointLight);


        gui.add(pointLight, 'intensity', 0.5, 5);
        gui.add(pointLight.position, 'y', 10, 30);
        gui.add(pointLight.position, 'x', -30, 30);
        gui.add(pointLight.position, 'z', -30, 30);


        var bottomBlock = getTransparentBottom();
        bottomBlock.position.y = -0.49;
        scene.add(bottomBlock);
        bottomBlock.name = 'bottom';

        // Make a sphere/cone to point out the control box.
        var ball = getCone(0.3);
        scene.add(ball);

        ball.position.x = box.position.x;
        ball.position.z = box.position.z;
        ball.name = 'cone';

        // Make buttons work.
        setButtonEvents();


        var raycaster = new THREE.Raycaster();
        var selectedObj = false;
		
		//Create a Car for Adventure//////////////////////
		var group = new THREE.Group();
		group.add(getCar());
		
		var wheel1 = getWheel(-1.2,-0.2,-1.2);
		var wheel2 = getWheel(1.2,-0.2,-1.2);
		var wheel3 = getWheel(-1.2,-0.2,1.2);
		var wheel4 = getWheel(1.2,-0.2,1.2);
		var backlight1 = getBackLight(-1,0.8,2.5);
		var backlight2 = getBackLight(1,0.8,2.5);
		
		var material_back = new THREE.MeshPhongMaterial();
		material_back.color=  new THREE.Color(1,0,0);
		var geometry_back = new THREE.BoxGeometry(0.6,0.3,0.6);
		var back1 = new THREE.Mesh(geometry_back,material_back);
		var back2 = new THREE.Mesh(geometry_back,material_back);
		back1.position.set(-1,0.55,1.75);
		back2.position.set(1,0.55,1.75);
		
		group.add(wheel1);
		group.add(wheel2);
		group.add(wheel3);
		group.add(wheel4);
		//group.add(backlight1); --got error.
		//group.add(backlight2);
		group.add(back1);
		group.add(back2);
		
		wheel1.castShadow = true;
		wheel2.castShadow = true;
		wheel3.castShadow = true;
		wheel4.castShadow = true;

		var camera_flag = 1;
		var moveForward=false;
		var moveLeft=false;
		var moveBackward=false;
		var moveRight=false;
		//////////////////////////////////////////////////////////




        //////////////
        // CONTROLS //
        //////////////

        // move mouse and: left   click to rotate,
        //                 middle click to zoom,
        //                 right  click to pan
        // add the new control and link to the current camera to transform its position
        controls = new THREE.OrbitControls(camera, renderer.domElement);
		

		
        // Constantly update the renderer/scene.
        var MyUpdateLoop = function () {

			//render according to a camera flag.
			//renderer.render(scene, camera);
			if(camera_flag<0) {
				renderer.render(scene,camera2);
			} else {
				renderer.render(scene,camera);
            }

            // Update the stats to monitor.
            stats.update();

            // Update the color of the control box
            colorChanger.SetColor();

            // Calculate time elapsed with the clock.
            var timeElapsed = clock.getElapsedTime();

            // Update the position of the pointer(which was a ball, but now a cone) of the control box
            ball.position.y = box.position.y + 2 + Math.sin(timeElapsed * 2) / 2;
            ball.rotation.y -= 0.05;
			
		// Car Animation
		var delta = clock2.getDelta(); // seconds.
		var moveDistance = 5 * delta; // 200 pixels per second
		var rotateAngle = Math.PI / 2 * delta;   // pi/2 radians (90 degrees) per second
		var rotation_matrix = new THREE.Matrix4().identity();
		
		if (moveLeft==true)
		{
			group.rotateOnAxis( new THREE.Vector3(0,1,0), rotateAngle);
		}
		if (moveRight==true)
		{
			group.rotateOnAxis( new THREE.Vector3(0,1,0), -rotateAngle);
		}
		if (moveForward==true)
		{
			group.translateZ( -moveDistance );
			wheel1.rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			wheel2.rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			wheel3.rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			wheel4.rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			 
		}
		if (moveBackward==true)
		{
			group.translateZ(  moveDistance );
			wheel1.rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			wheel2.rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			wheel3.rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			wheel4.rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
		}
		var relativeCameraOffset = new THREE.Vector3(0,5,13);
		var cameraOffset = relativeCameraOffset.applyMatrix4( group.matrixWorld );

        // Update camera position.
		camera2.position.x = relativeCameraOffset.x;
		camera2.position.y = relativeCameraOffset.y;
		camera2.position.z = relativeCameraOffset.z;
		camera2.lookAt( group.position );
      
		camera.updateProjectionMatrix();
		camera2.updateProjectionMatrix();
		/////////////////////////////////////////////////////////////////////////////////////////////////////
            //finally perform a recursive call to update again
            //this must be called because the mouse change the camera position
            requestAnimationFrame(MyUpdateLoop);

        };

        requestAnimationFrame(MyUpdateLoop);
		
	
    </script>


</body>
</html>








