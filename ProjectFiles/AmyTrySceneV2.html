<!DOCTYPE html>

<html>
<head>
    <title>Our 3D creation</title>

    <!-- This is the CSS style of this page. -->
    <link rel="stylesheet" href="stylesheet.css" type="text/css">

    <meta http-equiv="Content-type" content="text/html; charset=UTF-8" />

    <!--include the three.js library-->
    <script src="js/three.js"></script>
    <!--and the trackball code-->
    <script src="js/OrbitControls.js"></script>
    <!--include the dat.gui.min.js library to edit the scene in real time-->
    <script src="js/dat.gui.min.js"></script>
    <!--include the stats.js library-->
    <script src="js/stats.js"></script>

    <script src="js/PLYLoader.js"></script>

    <script src="js/MTLLoader.js" ></script>
    <script src="js/OBJLoader.js" ></script>

    <script src="js/jquery.min.js"></script>

</head>


<body>

    <!-- This div element is the top text space on the page. -->
    <div id="info">
        <p>
            Click your mouse to start moving the box!
            <br />
            left   click to rotate, middle click to zoom,  right  click to pan

        </p>

    </div>

    
        <!-- Control panel to interact with the scene -->
    <div id="controls">
        Control Panel
        <br />
        - Move the box
        <hr />

        <div id="camera-position">
            <button id="up">up (W)</button>
            <br />
            <button id="forward">forward (R)</button>
            <br />
            <button id="left">left (A)</button> MOVE <button id="right">right (D)</button>
            <br />
            <button id="backward">backward (F)</button>
            <br />
            <button id="down">down (S)</button>
            <br />
            <br />

        </div>
        <button id="set-box">Set block here!<br />(Enter)</button>
        <br />
        Control Virtual Block: <br /><button id="move">by Click</button>
        <button id="hide">Hide Control Block</button>
        <br />
        Selected Block:
        <button id="color">Pick Color</button>
        <button id="remove">Remove Block</button>
        <button id="remove-all">Remove All Blocks</button>

        <br />
        <button id="save">Save Your Work!</button>

        <button id="load">Load Previous Work!</button>
		
		<br/>
		
		<button id="adventure">Start Adventure!</button>
		<p>Move Car: <br />Forward(i),Backward(k),<br />Left(j),Right(l)<br />Turn On/Off headlight(Shift)</p>
		<button id="screenshot">Screen Shot</button>
        <br />


    </div>
    <!-- This script section is where we add THREE.JS code. -->
    <script>
        //create the scene and camera
        var scene = new THREE.Scene();

        // Monitor the performance.
        var stats = new Stats();
        document.body.appendChild(stats.dom);

        // Create interaction control panel.
     //   var gui = new dat.GUI();

        var ratio = window.innerWidth / window.innerHeight;
        var camera = new THREE.PerspectiveCamera(45, ratio, 1, 5000);
        // Place the camera (at the coordinate of its neareast parent.)
        camera.position.set(120, 180, 280);
        // Determine which point the camera is looking at.
        camera.lookAt(0, 0, 0);

        scene.add(camera);
		
		////////////////////////add an additional camera for adventure/////////////////////////
		var camera2 = new THREE.PerspectiveCamera(45,ratio,1,1000);
			camera2.position.set(0,8,5);
			camera2.lookAt(scene.position);	
		///////////////////////////////////////////////////////////////////////////////////////
        


    </script>

    <!-- This script section is the function to create and to update the renderer. -->
    <script src="scripts/UpdateRenderer.js"></script>

    <!-- This script section stores the functions about creating objects. -->
    <script src="scripts/CreateObjectsNew.js"></script>
    <script src="scripts/Collections.js"></script>
    <script src="scripts/ObjectsCreation.js"></script>
    <script src="scripts/ForestControl_v2.js"></script>

    <!-- This script section stores the functions about controlling the box with your keyboard. -->
    <script src="scripts/KeyboardOperation.js"></script>
	<script src="js/dat.gui.min.js"></script>


    <!-- This script section is where we add THREE.JS code. -->
    <script>

        // Add fog to the scene
        scene.fog = new THREE.FogExp2(0xffdcaa, 0.0001);

        // Use the clock to calculate time elapse.
        var clock = new THREE.Clock();
        const clock2 = new THREE.Clock();

        // Change the color of the background to grey.
        renderer.setClearColor(0x555555);


        // Make texture for objects.
        var loader = new THREE.TextureLoader();

        var ground = getPlane(301);

        // Create a plane to see the grid. Always use odd number, ohterwise the position is not accurate.

        ground.position.y = -0.50;

        //ground.material.color.setHex(0x88aa88);
        ground.name = 'ground';
        scene.add(ground);


        // Used to update block color
        var Color = function (object) {
            this.color = 0xee6666; // RGB with alpha

            // Define render logic ...
            object.material.color.setHex(this.color);

            this.SetColor = function () {
                object.material.color.setHex(this.color);
            }
        };

        var box = getBox(0x000000);
        box.name = 'control';

        scene.add(box);


        colorChanger = new Color(box);

           
        //////////////////////////////
        /// Add underground layers ///
        /////////////////////////////
        var underground = getSphere(300);
        scene.add(underground);
        var underground_plane = getPlaneUnderneath(300);
        underground_plane.name = 'ground';
        scene.add(underground_plane);


        var bone = getBoxBone();
        bone.visible = false;
        scene.add(bone);


  /////////////
    /// light ///
    /////////////
      var ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.2);
        scene.add(ambientLight);

        var hemiLight = new THREE.HemisphereLight(0x0000ff, 0x00ff00, 0.3);
        hemiLight.position.set(0,200,0);
        scene.add(hemiLight);

        var directionalLight = new THREE.DirectionalLight(0xFFFFFF);
        directionalLight.position.set(400, 300, 0);
        directionalLight.target.position.set(0, 0, 0);

        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024; //阴影映射宽度
        directionalLight.shadow.mapSize.height = 1024; //阴影映射高度
        directionalLight.shadow.camera.near = 50; //投影近点，距离光源多近能产生阴影
        directionalLight.shadow.camera.far = 1000; //投影远点，到哪一点为止不再产生阴影
        directionalLight.shadowCameraLeft = -300;
        directionalLight.shadowCameraRight = 300;
        directionalLight.shadowCameraTop = 300;
        directionalLight.shadowCameraBottom = -300;

        scene.add(directionalLight);
        scene.add(directionalLight.target);

    /////////////
    // control //
    /////////////
    var dirLightControl = new function() {
        this.intensity = 1;
        this.inclination = 30; //倾角 0-180
        this.azimuth = 90; //方位角 0-360
    };

    var gui = new dat.GUI();
    gui.add(dirLightControl, 'intensity', 0, 1).onChange(updateSun);
    gui.add(dirLightControl, 'inclination', 20, 50, 1).onChange(updateSun);
    gui.add(dirLightControl, 'azimuth', 0, 360, 1).onChange(updateSun);
        gui.addColor(colorChanger, 'color');

    /////////////
    /// 调参数 ///
    /////////////
    function updateSun() {
        //弧度 = 角度 * Math.PI / 180
        var distance = 500;
        var alpha = dirLightControl.inclination * Math.PI / 180;
        var beta = dirLightControl.azimuth * Math.PI / 180;

        directionalLight.intensity = dirLightControl.intensity;
        directionalLight.position.x = distance * Math.cos( alpha ) * Math.sin( beta );
        directionalLight.position.y = distance * Math.sin( alpha );
        directionalLight.position.z = - ( distance * Math.cos( alpha ) * Math.cos( beta ) );
    }


	    



        var bottomBlock = getTransparentBottom();
        bottomBlock.position.y = -0.49;
        scene.add(bottomBlock);
        bottomBlock.name = 'bottom';

        // Make a sphere/cone to point out the control box.
        var ball = getCone(0.3);
        scene.add(ball);

        ball.position.x = box.position.x;
        ball.position.z = box.position.z;
        ball.name = 'cone';

        // Make buttons work.
        setButtonEvents();
            
		
		///////////Create a Car for Adventure//////////////////////
		var group = new THREE.Group();
		group = getCar();
		
		var camera_flag = 1;
		var headlight_flag = -1;
		var moveForward=false;
		var moveLeft=false;
		var moveBackward=false;
		var moveRight=false;
		//////////////////////////////////////////////////////////

        //////////////
        // CONTROLS //
        //////////////

        // move mouse and: left   click to rotate,
        //                 middle click to zoom,
        //                 right  click to pan
        // add the new control and link to the current camera to transform its position
        controls = new THREE.OrbitControls(camera, renderer.domElement);
		

		
        // Constantly update the renderer/scene.
        var MyUpdateLoop = function () {

			//render according to a camera flag.
			//renderer.render(scene, camera);
			if(camera_flag<0) {
				renderer.render(scene,camera2);
			} else {
				renderer.render(scene,camera);
            }

            // Update the stats to monitor.
            stats.update();

            // Update the color of the control box
            colorChanger.SetColor();

            // Calculate time elapsed with the clock.
            var timeElapsed = clock.getElapsedTime();

            // Update the position of the pointer(which was a ball, but now a cone) of the control box
            ball.position.y = box.position.y + 2 + Math.sin(timeElapsed * 2) / 2;
            ball.rotation.y -= 0.05;
			
		// Car Animation
		var delta = clock2.getDelta(); // seconds.
		var moveDistance = 10 * delta; // 200 pixels per second
		var rotateAngle = Math.PI / 2 * delta;   // pi/2 radians (90 degrees) per second
		var rotation_matrix = new THREE.Matrix4().identity();
		
		if (moveLeft==true)
		{
			group.rotateOnAxis( new THREE.Vector3(0,1,0), rotateAngle);
		}
		if (moveRight==true)
		{
			group.rotateOnAxis( new THREE.Vector3(0,1,0), -rotateAngle);
		}
		if (moveForward==true)
		{
			group.translateZ( -moveDistance );
			group.getObjectByName("wheel1").rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			group.getObjectByName("wheel2").rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			group.getObjectByName("wheel3").rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			group.getObjectByName("wheel4").rotateOnAxis( new THREE.Vector3(0,1,0), 0.3);
			 
		}
		if (moveBackward==true)
		{
			group.translateZ(  moveDistance );
			group.getObjectByName("wheel1").rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			group.getObjectByName("wheel2").rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			group.getObjectByName("wheel3").rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
			group.getObjectByName("wheel4").rotateOnAxis( new THREE.Vector3(0,1,0), -0.3);
		}
		var relativeCameraOffset = new THREE.Vector3(0,5,13);
		var cameraOffset = relativeCameraOffset.applyMatrix4( group.matrixWorld );

        // Update camera position.
		camera2.position.x = relativeCameraOffset.x;
		camera2.position.y = relativeCameraOffset.y;
		camera2.position.z = relativeCameraOffset.z;
        camera2.lookAt(group.position.x, group.position.y + 4, group.position.z);
		
		camera.updateProjectionMatrix();
		camera2.updateProjectionMatrix();
		/////////////////////////////////////////////////////////////////////////////////////////////////////
            //finally perform a recursive call to update again
            //this must be called because the mouse change the camera position
            requestAnimationFrame(MyUpdateLoop);

        };

        requestAnimationFrame(MyUpdateLoop);
		
	
    </script>


</body>
</html>








